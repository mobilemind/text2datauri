---
# yamllint disable rule:line-length
name: "Publish to npm"

# Trigger on GitHub releases for controlled publishing
'on':
  release:
    types: [published]
  # Allow manual trigger for testing (will do a dry-run)
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Perform dry-run (do not actually publish)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

# Minimal permissions following principle of least privilege
permissions:
  contents: write  # Required to update release notes
  id-token: write  # Required for OIDC/trusted publishing and provenance

jobs:
  publish:
    name: "Publish to npm with Provenance"
    runs-on: ubuntu-latest

    # Only run on main branch to prevent accidental publishes from forks
    if: github.repository == 'mobilemind/text2datauri' && (github.event_name == 'release' || github.event_name == 'workflow_dispatch')

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v56
        with:
          # Fetch full history for potential version checks
          fetch-depth: 0

      - name: "Setup Node.js"
        uses: actions/setup-node@v6
        with:
          node-version: '22.x'
          registry-url: 'https://registry.npmjs.org'
          # OIDC trusted publishing: npm CLI automatically uses OIDC for authentication
          # - id-token: write permission enables OIDC token generation
          # - Provenance attestations are automatically generated
          # - No long-lived tokens required - short-lived per-publish credentials

      - name: "Run tests"
        run: npm test
        # No install needed - we have ZERO dependencies

      - name: "Security audit"
        run: |
          # This package has ZERO production dependencies
          # Any vulnerabilities are in peerDependencies (grunt's js-yaml issue)
          # which are user's responsibility, not ours
          npm audit --omit=dev --audit-level=moderate || {
            echo "‚ö†Ô∏è  Audit found vulnerabilities in peerDependencies (expected: grunt's js-yaml)"
            echo "    This package has ZERO production dependencies - these are not our issues"
            exit 0
          }

      - name: "Verify package contents"
        run: |
          npm pack --dry-run
          echo "‚úì Package contents verified"

      - name: "Generate Release Notes"
        if: github.event_name == 'release'
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/}"
          PREV_TAG=$(git describe --abbrev=0 --tags "${TAG_VERSION}^" 2>/dev/null || echo "")

          {
            if [ -n "$PREV_TAG" ]; then
              echo "## What's Changed"
              echo ""
              git log --pretty=format:"- %s (%h)" "$PREV_TAG..HEAD"
            else
              echo "## Release $TAG_VERSION"
              echo ""
              echo "Initial release"
            fi

            echo ""
            echo "## Verification"
            echo ""
            echo "This release includes:"
            echo "- Signed commits and tags (verify with \`git verify-tag $TAG_VERSION\`)"
            echo "- Security audit results from CI pipeline"
            echo "- npm provenance attestation"
            echo ""
            echo "See the [npm package page](https://www.npmjs.com/package/text2datauri) for verification."
          } > release-notes.md

          echo "Release notes preview:"
          cat release-notes.md

      - name: "Update Release Notes"
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release edit "${GITHUB_REF#refs/tags/}" --notes-file release-notes.md

      - name: "Check package.json version matches release tag"
        if: github.event_name == 'release'
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          RELEASE_TAG=${GITHUB_REF#refs/tags/}
          echo "Package version: $PACKAGE_VERSION"
          echo "Release tag: $RELEASE_TAG"

          # Strip 'v' prefix if present in tag
          RELEASE_VERSION=${RELEASE_TAG#v}

          if [ "$PACKAGE_VERSION" != "$RELEASE_VERSION" ]; then
            echo "‚ùå Version mismatch: package.json has $PACKAGE_VERSION but release tag is $RELEASE_TAG"
            exit 1
          fi
          echo "‚úì Version matches release tag"

      - name: "Publish to npm (dry-run)"
        if: github.event_name == 'workflow_dispatch' && inputs.dry_run == 'true'
        run: |
          echo "üß™ Dry-run mode - not actually publishing"
          npm publish --dry-run --access public
          echo "‚úì Dry-run successful - package would be published"

      - name: "Publish to npm with provenance"
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.dry_run == 'false')
        run: |
          echo "Publishing with OIDC trusted publishing..."
          npm publish --access public --verbose
        # OIDC trusted publishing:
        # - Authentication via short-lived JWT token (no NODE_AUTH_TOKEN needed)
        # - Provenance attestations automatically generated (no --provenance flag needed)
        # - Requires: id-token: write permission, npm CLI v11.5.1+, trusted publisher configured on npmjs.com

      - name: "Verify publication"
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.dry_run == 'false')
        run: |
          PACKAGE_VERSION="$(node -p "require('./package.json').version")"
          echo 'Waiting 30 seconds for npm registry to update...'
          sleep 30

          echo "Verifying publication of text2datauri@$PACKAGE_VERSION"
          npm view "text2datauri@$PACKAGE_VERSION" version

          echo '‚úì Package successfully published and verified'
          echo "üì¶ View at: https://www.npmjs.com/package/text2datauri/v/$PACKAGE_VERSION"

      - name: "Check provenance attestation"
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.dry_run == 'false')
        run: |
          PACKAGE_VERSION="$(node -p "require('./package.json').version")"
          echo 'Checking for provenance attestation...'
          sleep 10  # Give npm time to process attestation

          # Try to fetch provenance info (npm 9.5.0+)
          npm view "text2datauri@$PACKAGE_VERSION" --json | jq -r '.publishConfig.provenance // "No provenance data yet"' || true

          echo '‚ÑπÔ∏è  Provenance attestation may take a few minutes to appear on npm'
          echo "üìã Check later at: https://www.npmjs.com/package/text2datauri/v/$PACKAGE_VERSION"
